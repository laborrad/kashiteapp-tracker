name: Sync Issues from Main Repo

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync Issue to Main Repository
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const action = context.payload.action;
            
            // „É´„Éº„ÉóÈò≤Ê≠¢: Êó¢„Å´ÂêåÊúü„Çø„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (issue && issue.body && issue.body.includes('[sync-src:main#')) {
              console.log('Already synced from main repo, skipping');
              return;
            }
            
            const mainOwner = 'laborrad';
            const mainRepo = 'kashiteapp';
            
            try {
              if (action === 'opened') {
                // Êñ∞Ë¶èIssue„ÅÆ‰ΩúÊàê
                const newIssue = await github.rest.issues.create({
                  owner: mainOwner,
                  repo: mainRepo,
                  title: `[Tracker] ${issue.title}`,
                  body: `${issue.body || ''}\n\n---\nüìã [„Éà„É©„ÉÉ„Ç´„Éº„ÅÆIssue](${issue.html_url}) [sync-src:tracker#${issue.number}]`,
                  labels: issue.labels.map(l => l.name)
                });
                console.log(`Created issue #${newIssue.data.number} in main repo`);
                
                // „Éà„É©„ÉÉ„Ç´„ÉºÂÅ¥„ÅÆIssue„Å´Êú¨‰Ωì„É™„Éù„ÅÆIssueÁï™Âè∑„ÇíËøΩË®ò
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `‚úÖ Êú¨‰Ωì„É™„Éù„Ç∏„Éà„É™„Å´ÂêåÊúü„Åó„Åæ„Åó„Åü: [kashiteapp#${newIssue.data.number}](${newIssue.data.html_url})`
                });
                
              } else if (action === 'closed' || action === 'reopened') {
                // Êú¨‰ΩìÂÅ¥„ÅÆÂØæÂøú„Åô„ÇãIssue„ÇíÊé¢„Åó„Å¶„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                const { data: mainIssues } = await github.rest.issues.listForRepo({
                  owner: mainOwner,
                  repo: mainRepo,
                  state: 'all',
                  per_page: 100
                });
                
                const syncTag = `[sync-src:tracker#${issue.number}]`;
                const mainIssue = mainIssues.find(mi => mi.body && mi.body.includes(syncTag));
                
                if (mainIssue) {
                  await github.rest.issues.update({
                    owner: mainOwner,
                    repo: mainRepo,
                    issue_number: mainIssue.number,
                    state: issue.state
                  });
                  console.log(`Updated main issue #${mainIssue.number} state to ${issue.state}`);
                }
                
              } else if (comment && action === 'created') {
                // „Ç≥„É°„É≥„Éà„ÅÆÂêåÊúü
                const { data: mainIssues } = await github.rest.issues.listForRepo({
                  owner: mainOwner,
                  repo: mainRepo,
                  state: 'all',
                  per_page: 100
                });
                
                const syncTag = `[sync-src:tracker#${issue.number}]`;
                const mainIssue = mainIssues.find(mi => mi.body && mi.body.includes(syncTag));
                
                if (mainIssue) {
                  await github.rest.issues.createComment({
                    owner: mainOwner,
                    repo: mainRepo,
                    issue_number: mainIssue.number,
                    body: `**${comment.user.login}** (tracker) commented:\n\n${comment.body}\n\n---\n[ÂÖÉ„ÅÆ„Ç≥„É°„É≥„Éà](${comment.html_url})`
                  });
                  console.log(`Added comment to main issue #${mainIssue.number}`);
                }
              }
            } catch (error) {
              console.error('Error syncing to main repo:', error);
              throw error;
            }
